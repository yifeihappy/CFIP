<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<meta name="description" content="">
		<meta name="author" content="">

		<title id="titleText">chat</title>

		<!-- Bootstrap core CSS -->
		<link href="../../css/bootstrap.min.css" rel="stylesheet">

		<!-- Custom styles for this template -->
		<link href="../../css/dyf/index.css" rel="stylesheet">
		<link rel="stylesheet" href="../../css/dyf/chatIndex.css" />
		<script src="../../jquery/jquery-3.2.1.min.js "></script>
		<script src="../../js/bootstrap.min.js"></script>
		<script type="text/javascript" src="../../js/dyf/user.js"></script>
		<script type="text/javascript" src="../../js/dyf/chatIndex.js"></script>
	</head>

	<body>

		<nav class="navbar navbar-fixed-top navbar-inverse">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            			<span class="sr-only">Toggle navigation</span>
           				<span class="icon-bar"></span>
            			<span class="icon-bar"></span>
            			<span class="icon-bar"></span>
          			</button>
					<div class="nav navbar-nav navbar-header">
						<li>
							<img src="../../img/logo.png" width="44px" height="44px" />
						</li>
						<li>
							<a href="" id="CFIP" style="text-decoration:none">CFIP</a>
						</li>
					</div>
				</div>
				<div id="navbar" class="collapse navbar-collapse">
					<ul class="nav navbar-nav">
						<li>
							<a href="" id="chat">Chat</a>
						</li>
						<li>
							<a href="" id="act">活动</a>
						</li>
						<li>
							<a href="" id="topic">话题</a>
						</li>
						<li>
							<a href="" id="dengShen">灯神</a>
						</li>
					</ul>

					<form class="navbar-form navbar-left">
						<div class="form-group">
							<input type="text" class="form-control" placeholder="活动/话题">
						</div>
						<button type="submit" class="btn btn-default" disabled="true">搜索</button>
					</form>

					<ul class="nav navbar-nav navbar-right " ng-if="!userService.isLogin">
						<!--<div id="signinDiv" hidden=true>-->
						<li id="signinLI">
							<a href="/CFIP/cfip/user/signin.html">登录</a>
						</li>
						<!--</div>-->
						<!--<div id="signupDiv" hidden=true>-->
						<li id="signupLI" ng-hide="userService.isLogin">
							<a href="/CFIP/cfip/user/signup.html">注册</a>
						</li>
						<!--</div>-->
						<!--<div id="userCenterDiv" hidden=true>-->
						<li id="userCenterLI" class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
								<span class="glyphicon glyphicon-user" aria-hidden="true"></span><span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li>
									<a href="" id="personalCenter">个人中心</a>
								</li>
								<li>
									<a href="/CFIP/index.html">退出</a>
								</li>
							</ul>
						</li>
						<!--</div>-->
						<!--<div id="publishDiv" hidden=true>-->
						<li id="publishLI" class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
								<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>发布<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li>
									<a herf="" id="addAct">活动</a>
								</li>
								<li>
									<a herf="" id="addTopic">话题</a>
								</li>
								<li role="separator" class="divider"></li>
								<li>
									<a herf="" id="addWall">上墙</a>
								</li>
							</ul>
						</li>
						<!--</div>-->

					</ul>
				</div>
				<!-- /.nav-collapse -->
			</div>
			<!-- /.container -->
		</nav>
		<!-- /.navbar -->

		<div class="container">
			<div class="row">
				<div class="col-md-1 col-md-offset-1 " id="menu">
					<ul class="nav nav-sidebar">
						<li id="contactsMenu" class="active" style="text-align: center;margin: 0px; ">
							<a href=" " style="padding: 0px; "><span class="glyphicon glyphicon-user" aria-hidden="true " style="color:gray;font-size:50px; "></span>Student</a>
							<!--<a href=" " style="margin: 0px; "></span></a>-->
						</li>
						<li id="messageMenu" style="text-align: center;margin: 0px; ">
							<!--<a href=" " style="padding: 0px "><span class="glyphicon glyphicon-envelope " aria-hidden="true " style="color:gray;font-size:50px; "></span></a>-->
							<a href=" " style="padding: 0px "><span class="glyphicon glyphicon-user" aria-hidden="true " style="color:gray;font-size:50px; "></span>Teacher</a>
						</li>
					</ul>
				</div>
				<!--"/col-md-1 col-md-offset-1 "-->
				<div class="col-md-2 ">
					<ul id="contactsUl" class="nav nav-sidebar ">
<!--						<li style="background-color: #000;"><a href="">Tom1</a></li>-->
					</ul>
					<ul id="messageUl" class="nav nav-sidebar " hidden="">
						<!--<li>
							<a>消息1</a>
						</li>-->
					</ul>
				</div>
				<!--</div class="col-md-2 ">-->
				<div class="col-md-7 ">
					<div class="row" style="min-height: 20px; border:2px solid crimson; ">
						<div class="col-sm-3" id="diaglogUser">

						</div>
					</div>
					<div class="row">
						<div id="allMessagePlane" class="col-sm-12 " style="min-height: 200px; border:1px solid #1B6D85; ">

						</div>
					</div>

					<div class="row " style=" border:1px solid #1B6D85;margin-top: 10px; ">
						<div class="col-sm-10 form-group " style="margin-top: 10px; ">
							<div class="row">
								<div class="col-sm-12">
									<textarea id="messageTextarea" rows="6 " class="form-control " autofocus style="overflow-x:hidden "></textarea>
								</div>
							</div>
							<div class="row">
								<div class="col-sm-12">
									<input type="file" class="form-control btn btn-block" id="fileBtn" placeholder="选择文件">
								</div>
							</div>
						</div>
						<div class="col-sm-2 form-group " style="padding: 0px;margin-top: 10px;padding-right: 10px; ">
							<div style="margin-bottom: 10px; ">
								<button id="sendBtn" class="form-control btn btn-block " style="background-color:#269ABC ">发生信息</button>
							</div>
							<div>
								<button id="sendFileBtn" class="form-control btn btn-block " style="background-color:#269ABC ">发送文件</button>
								<!--<input type="file" class="form-control btn btn-block" id="fileBtn" placeholder="选择文件">-->
							</div>
						</div>
					</div>
				</div>
				<!--</div class="col-md-7 ">-->
			</div>
		</div>

		<!-- Bootstrap core JavaScript
    ================================================== -->
		<!-- Placed at the end of the document so the pages load faster -->
		<script>
			var userID;
			var userIDMsgTriggerID;
			var curYID = ""; //当前对话窗口的对方用户ID
			var curYIDMsgTriggerID;
			var studentArray;
			var teacherArray;
			var msgPlaneMap = {}; //记录所有的MessagePlane
			var source; //监听
			var formData; //文件数据
			$(document).ready(function() {
				userID = isSignIn(); //判断用户有没有登录进行页面变化
				console.log(userID);
				$("#titleText").text(userID);
				//userID = "1513685380811";//201330550222
				//curYID = "1513685359511";
				userIDMsgTriggerID = getMessageTrigger(userID);
				source = new EventSource("http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Messagetrigger/" + userIDMsgTriggerID + "/syncronize");
				creatContactList();
				console.log("监听：" + userIDMsgTriggerID);
				listenToMessageTrigger();
				hasHistoryMessage();
				//createIImgItem();
				//createYImgItem();
				//createIVedioItem();
				//createYVedioItem();
				$("#contactsMenu").click(function() {
					$("#contactsUl").show();
					$("#messageUl").hide();
					return false; //==window.event.returnValue = false;
				});

				$("#messageMenu").click(function() {
					$("#contactsUl").hide();
					$("#messageUl").show();
					return false;
				});

				$("#sendBtn").click(function() {
					if(curYID == "") {
						alert("请先选中联系人");
					} else {
						var msg = $("#messageTextarea").val(); //获取当前textarea文本框里的消息
						console.log(msg);
						if("" == msg) {
							alert("输入信息不能为空！");
						} else {
							$("#messageTextarea").val(""); //清空

							var currentTime = getFormatDate(); //获取当前时间
							/***改变当前的页面，添加自己发送信息的内容******/
							var myNewItem = createIMsgItem(userID, currentTime, msg);

							msgPlaneMap["Tr" + curYID].append(myNewItem);
							//createYMsgItem(userID, currentTime, msg);

							/******发送信息******/
							var msgIObj = {
								fromuserid: parseInt(userID),
								touserid: parseInt(curYID),
								msgcontent: msg,
								state: "1",
								msgtime: currentTime,
								type: "1"
							};
							var msgJsonStr = JSON.stringify(msgIObj);
							console.log(msgJsonStr);
							$.ajax({
								type: "POST",
								url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Message/",
								contentType: "application/json",
								data: msgJsonStr,
								async: true,
								success: function(data, state) {
									console.log("发送信息成功");
									//改变对方监听的数据
									var msgTriggerObj = {
										userid: parseInt(curYID),
										state: "1"
									};
									var msgJsonStrTr = JSON.stringify(msgTriggerObj);
									console.log("改变触发器：" + msgJsonStrTr + ":" + 1);
									$.ajax({
										type: "put",
										url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Messagetrigger/" + curYIDMsgTriggerID,
										contentType: "application/json",
										data: msgJsonStrTr,
										async: true,
										success: function(data, state) {
											console.log("trigger success");
										},
										error: function(data, state) {
											console.log("trigger fialier!");
										}
									});
								},
								error: function(data, state) {
									alert("发送信息失败！");
								}
							});

						}
					}

				});

				$("#sendFileBtn").click(function() {

					if(curYID == "") {
						alert("请先选中联系人");
					} else {
						var files = $(":file")[0].files;
						console.log(files);
						console.log(files.length);
						if(0 != files.length) {
							formData = new FormData();
							formData.append("file", files[0]);
							console.log(files[0].name);
							//console.log();
							var currentTime = getFormatDate(); //获取当前时间

							var fileType = "0";
							if(files[0].name.endsWith('jpg')) {
								console.log("你选择的是一张jpg图片");
								fileType = "2"
							} else if(files[0].name.endsWith("mp4")) {
								console.log("你选择的是个mp4视频");
								fileType = "3";
							} else {
								alert("文件格式不正确");
							}
							/******发送信息******/
							var msgIObj = {
								fromuserid: parseInt(userID),
								touserid: parseInt(curYID),
								msgcontent: files[0].name,
								state: "1",
								msgtime: currentTime,
								type: fileType
							};
							var msgJsonStr = JSON.stringify(msgIObj);
							$.ajax({
								type: "POST",
								url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Message/",
								contentType: "application/json",
								data: msgJsonStr,
								async: true,
								success: function(data, state) {
									console.log("发送文件成功0.5");
									console.log(data);
									var myNewItem;
									if(data.type == "2") {
										myNewItem = createIImgItem(userID, data.msgtime, data.msgcontent, data.id); //自身页面添加文件
									} else if(data.type == "3") {
										myNewItem = createIVedioItem(userID, data.msgtime, data.msgcontent, data.id); //自身页面添加文件
									}

									msgPlaneMap["Tr" + curYID].append(myNewItem);
									//发生文件
									$.ajax({
										//http://112.74.35.75:8080/file/U3d616b41047817/CFIP/Activity/1513472664404
										url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Message/" + data.id,
										type: "POST",
										data: formData,
										async: false,
										contentType: false,
										processData: false,
										error: function(dataImg, stateImg) {
											console.log("发送文件失败" + stateImg);
											console.log(dataImg);
											//return false;
										},
										success: function(dataImg, stateImg) {
											console.log("发送文件成功1");
											console.log(stateImg);
											console.log(dataImg);
										}
									});

									//改变对方监听的数据
									var msgTriggerObj = {
										userid: parseInt(curYID),
										state: "1"
									};
									var msgJsonStrTr = JSON.stringify(msgTriggerObj);
									console.log("改变触发器：" + msgJsonStrTr + ":" + 1);
									$.ajax({
										type: "put",
										url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Messagetrigger/" + curYIDMsgTriggerID,
										contentType: "application/json",
										data: msgJsonStrTr,
										async: true,
										success: function(data, state) {
											console.log("trigger success");
										},
										error: function(data, state) {
											console.log("trigger fialier!");
										}
									});
								},
								error: function(data, state) {
									alert("发送信息失败！");
								}
							});

							var obj = document.getElementById('fileBtn');
							obj.outerHTML = obj.outerHTML;
							console.log($(":file")[0].files.length);
						} else {
							alert("请先选择文件");
						}
					}

				});
			})
		</script>
	</body>

</html>