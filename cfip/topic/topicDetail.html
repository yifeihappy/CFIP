<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<meta name="description" content="">
		<meta name="author" content="">

		<title>Off Canvas Template for Bootstrap</title>

		<!-- Bootstrap core CSS -->
		<link href="../../css/bootstrap.min.css" rel="stylesheet">

		<!-- Custom styles for this template -->
		<link href="../../css/dyf/index.css" rel="stylesheet">
		<script src="../../jquery/jquery-3.2.1.min.js "></script>
		<script src="../../js/bootstrap.min.js"></script>
		<script src="../../js/dyf/user.js"></script>
		<style type="text/css">
			td {
				text-align: center;
			}
			
			.topic-detail {
				border: 2px black solid;
			}
			
			.comment {
				border: 2px black solid;
				min-height: 100px;
			}
		</style>
	</head>

	<body>

		<nav class="navbar navbar-fixed-top navbar-inverse">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
					<div class="nav navbar-nav navbar-header">
						<li>
							<img src="../../img/logo.png" width="44px" height="44px" />
						</li>
						<li>
							<a href="" id="CFIP" style="text-decoration:none">CFIP</a>
						</li>
					</div>
				</div>
				<div id="navbar" class="collapse navbar-collapse">
					<ul class="nav navbar-nav">
						<li>
							<a href="" id="chat">Chat</a>
						</li>
						<li>
							<a href="" id="act">活动</a>
						</li>
						<!--<li>
							<a href="cfip/topic/topic.html">话题</a>
						</li>-->
						<li class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">话题<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li>
									<a href="#">明星</a>
								</li>
								<li>
									<a href="#">搞笑</a>
								</li>
								<li>
									<a href="#">情感</a>
								</li>
								<li>
									<a href="#">时尚</a>
								</li>
								<li>
									<a href="#">军事</a>
								</li>
								<li>
									<a href="#">美女</a>
								</li>
								<li>
									<a href="#">体育</a>
								</li>
								<li>
									<a href="#">动漫</a>
								</li>
								<li role="separator" class="divider"></li>
								<li>
									<a href="#">其它</a>
								</li>
							</ul>
						</li>
						<li>
							<a href="" id="dengShen">灯神</a>
						</li>
						<!--<li class="dropdown">
										<a href="act.html" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">活动 <span class="caret"></span></a>
										<ul class="dropdown-menu">
											<li>
												<a href="#">比赛</a>
											</li>
											<li>
												<a href="#">公益</a>
											</li>
											<li>
												<a href="#">户外</a>
											</li>
											<li>
												<a href="#">讲座</a>
											</li>
											<li>
												<a href="#">艺术</a>
											</li>
											<li>
												<a href="#">游学</a>
											</li>
											<li>
												<a href="#">招聘</a>
											</li>
											<li>
												<a href="#">招新</a>
											</li>
											<li role="separator" class="divider"></li>
											<li>
												<a href="#">其它</a>
											</li>
										</ul>
									</li>-->
						<!--<li class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">话题<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li>
									<a href="#">明星</a>
								</li>
								<li>
									<a href="#">搞笑</a>
								</li>
								<li>
									<a href="#">情感</a>
								</li>
								<li>
									<a href="#">时尚</a>
								</li>
								<li>
									<a href="#">军事</a>
								</li>
								<li>
									<a href="#">美女</a>
								</li>
								<li>
									<a href="#">体育</a>
								</li>
								<li>
									<a href="#">动漫</a>
								</li>
								<li role="separator" class="divider"></li>
								<li>
									<a href="#">其它</a>
								</li>
							</ul>
						</li>-->
						<!--<li class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">灯神<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li>
									<a href="#">表白墙</a>
								</li>
								<li>
									<a href="#">心愿墙</a>
								</li>
								<li>
									<a href="#">闲物店</a>
								</li>
							</ul>
						</li>-->
					</ul>

					<form class="navbar-form navbar-left">
						<div class="form-group">
							<input type="text" class="form-control" placeholder="活动/话题">
						</div>
						<button type="submit" class="btn btn-default">搜索</button>
					</form>

					<ul class="nav navbar-nav navbar-right " ng-if="!userService.isLogin">
						<!--<div id="signinDiv" hidden=true>-->
						<li id="signinLI">
							<a href="/CFIP/cfip/user/signin.html">登录</a>
						</li>
						<!--</div>-->
						<!--<div id="signupDiv" hidden=true>-->
						<li id="signupLI" ng-hide="userService.isLogin">
							<a href="/CFIP/cfip/user/signup.html">注册</a>
						</li>
						<!--</div>-->
						<!--<div id="userCenterDiv" hidden=true>-->
						<li id="userCenterLI" class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
								<span class="glyphicon glyphicon-user" aria-hidden="true"></span><span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li>
									<a href="" id="personalCenter">个人中心</a>
								</li>
								<li>
									<a href="/CFIP/index.html">退出</a>
								</li>
							</ul>
						</li>
						<!--</div>-->
						<!--<div id="publishDiv" hidden=true>-->
						<li id="publishLI" class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
								<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>发布<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li>
									<a herf="" id="addAct">活动</a>
								</li>
								<li>
									<a herf="" id="addTopic">话题</a>
								</li>
								<li role="separator" class="divider"></li>
								<li>
									<a herf="" id="addWall">上墙</a>
								</li>
							</ul>
						</li>
						<!--</div>-->

					</ul>
				</div>
				<!-- /.nav-collapse -->
			</div>
			<!-- /.container -->
		</nav>
		<!-- /.navbar -->

		<div id="topicDetail-thumbnails" class="container">
			<!--<div class="row">-->
			<!--<a href="/CFIP/index.html?userID=123345">-->
			<!--<div class="topic-detail col-md-8 col-md-offset-2">-->

			<!--<div class="row">
							<div class="col-md-4 col-sm-4 col-xs-4 thumbnail">
								<img src="../../img/Desert.jpg" alt="...">
							</div>
							<div class="col-md-8 col-sm-8 col-xs-8 caption">
								<h3>Topic Name</h3>
								<p>话题内容</p>
								<p>发布人</p>
								<p>发布时间</p>
							</div>
						</div>
						<hr>-->
			<!--<div class="row">
							<div class="comment col-md-12">
								<p>评论人：评论内容</p>
								<p>评论时间</p>
							</div>
						</div>-->

			<!--</div>-->
			<!--<div class="col-md-8 col-md-offset-2">-->
			<!--</a>-->
			<!--	</div>-->
			<!--<div class="row">
				<div class="col-md-8 col-md-offset-2">
					<h1>This is Header of the activity!This is Header of the activity!This is Header of the activity!</h1>
					<hr></hr>
					<div>
						<img src="../../img/Desert.jpg" width="750px" height="500px" />
					</div>-->
			<!--<div>
						<table class="table">
							<tr>
								<td>活动开始时间</td>
								<td>12月17日 13：00-15：15</td>
							</tr>
							<tr>
								<td>活动结束时间</td>
								<td>12月17日 13：00-15：15</td>
							</tr>
							<tr>
								<td>报名开始时间</td>
								<td>12月17日 13：00-15：15</td>
							</tr>
							<tr>
								<td>报名结束时间</td>
								<td>12月17日 13：00-15：15</td>
							</tr>
						</table>-->
			<!--</div>
					<hr></hr>
					<div>
						<span>
							关于AI，他们要说——
							霍金：全面人工智能化会导致人类灭亡。
							马斯克：人工智能是人类生存最大威胁。
							比尔・盖茨：人类需要敬畏AI的崛起。
							关于AI，我们想问——
							Alpha Go是如何打败柯杰的？
							siri是如何一步步“沦落”至任人调戏？
							AI程序员们内心究竟寄居着怎样的小怪兽？
							这一次
							我们聚集了行业大神，
							学术大牛试图为你提供最全面的答案
						</span>
					</div>-->
			<!--<hr></hr>
					<div>
						<table class="table">
							<tr>
								<td>
									主办方
								</td>
								<td>
									小雪
								</td>
							</tr>
							<tr>
								<td>
									地点
								</td>
								<td>
									菁菁堂
								</td>
							</tr>
							<tr>
								<td>-->
			<!--总人数
								</td>
								<td>
									100
								</td>
							</tr>
							<tr>
								<td>
									已报名人数
								</td>
								<td>
									66
								</td>
							</tr>
						</table>
					</div>-->

			<!--</div>-->
			<!--				<!--/.col-md-8 col-md-offset-2>-->
			<!--</div>-->
		</div>
		<div id="Comments" class="container">

			<div class="row">
				<div class=" col-md-8 col-md-offset-2">
					<p>评论人：评论内容</p>
					<p>评论时间</p>
					<hr>
				</div>

			</div>

		</div>
		<div class="container">
			<div class="row">
				<div class=" col-md-8 col-md-offset-2">

					<div class="form-group">
						<label>说点什么吧</label>
						<textarea class="form-control" rows="3" id="CommentsBrief"></textarea>
					</div>
					<div id="CommentsSubmit" class="btn btn-lg btn-primary btn-block">Submit</div>
				</div>
			</div>
		</div>

	</body>
	<script>
		$(document).ready(function() {
			/**********判断用户有无登录 start*********/
			var userID = isSignIn(); //判断用户有没有登录进行页面变化
			//userID = 1513502243526;
			/**********判断用户有无登录 end*********/
			var Title;
			var Authorname;
			var Authorid;
			var Brief;
			var Publishtime;
			var Commentnumber;
			var Topictype;
			var Viewernumber;
			var urlStr = decodeURI(window.location.href);
			urlStrArray1 = urlStr.split("topicID=");
			if(userID == "") {
				console.log("userID null");
				topicID = urlStrArray1[1];
			} else {
				console.log("userID:" + userID);
				urlStrArray2 = urlStrArray1[1].split("userID=");
				topicID = urlStrArray2[0];
			}
			console.log(topicID);
			//加载话题内容
			$.ajax({
				type: "get",
				url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Topic/" + topicID,
				//url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Student/?Student.",
				async: false,
				success: function(data, state) {
					console.log(state);
					console.log(data);

					Title = data.title;
					Authorname = data.authorname;
					Authorid = data.authorid;
					Brief = data.brief;
					Publishtime = data.publishtime;
					Commentnumber = data.commentnumber;
					Topictype = data.topictype;
					Viewernumber = data.viewernumber;

					var Viewerinfo = {
						title: Title,
						authorname: Authorname,
						authorid: Authorid,
						brief: Brief,
						publishtime: Publishtime,
						commentnumber: Commentnumber,
						topictype: Topictype,
						viewernumber: Viewernumber + 1
					};
					var dataJsonStr = JSON.stringify(Viewerinfo);
					console.log(dataJsonStr);
					//浏览量+1
					$.ajax({
						url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Topic/" + topicID,
						contentType: "application/json",
						type: "PUT",
						data: dataJsonStr,
						async: false,
						error: function(data, state) {
							//console.log(dataJsonStr);
							console.log(data);
							console.log(state);
						},
						success: function(data, state) {
							console.log(state);
							console.log(data);
						}
					});
					//加载评论
					$.ajax({
						type: "get",
						url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Comments/?Comments.topicid=" + topicID,
						//url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Student/?Student.",
						async: false,
						success: function(data, state) {
							console.log(state);
							console.log(data);
							if(JSON.stringify(data) != "{}") {
								for(var i = 0; i < data.Comments.length; i++) {
									var Ctext = $("<p></p>").text(data.Comments[i].username + ":" + data.Comments[i].brief);
									var Ctime = $("<p></p>").text(data.Comments[i].commentstime);
									var div1 = $("<div class='col-md-8 col-md-offset-2'></div>");
									div1.append(Ctext, Ctime, $("<hr>"));

									div2 = $("<div class='row'></div>");
									div2.append(div1);

									$("#Comments").append(div2);

								}
							}

						},
						error: function(data, state) {
							console.log(state);
							console.log(data);
						}

					});

					var hTitle = $("<h3></h3>").text(data.title);
					var pText = $("<p></p>").text(data.brief);
					var ppers = $("<p></p>").text("发布人：" + data.authorname);
					var pTopTime = $("<p></p>").text("发布时间：" + data.publishtime);
					var divCaption = $("<div class='row'></div>");
					divCaption.append(hTitle, pText, ppers, pTopTime, );

					var imgTopic = $("<img></img>").attr({
						"src": "http://112.74.35.75:8080/file/U3d616b41047817/CFIP/Topic/" + topicID,
						"alt": "...."
					});
					var divThumbnail = $("<div class='col-md-4 col-sm-4 col-xs-4 thumbnail'></div>");
					divThumbnail.append(imgTopic);

					var div3 = $("<div class='col-md-8 col-sm-8 col-xs-8 caption'></div>");
					div3.append(divCaption);

					var divRow1 = $("<div class='row'></div>");
					divRow1.append(divThumbnail, div3);

					var div1 = $("<div class='col-md-8 col-md-offset-2'></div>");
					div1.append(divRow1);

					//												var topicDetailUrl;
					//												if("" == userID) {
					//													topicDetailUrl = "/CFIP/cfip/topic/topicDetail.html?actID=" + data.Topic[i].id;
					//												} else {
					//													topicDetailUrl = encodeURI("/CFIP/cfip/topic/topicDetail.html?actID=" + data.Topic[i].id + "&userID=" + userID);
					//												}
					//					//
					//							var topicDetailA = $("<a></a>").attr("href", topicDetailUrl);
					//							topicDetailA.append(div1);

					var divRow2 = $("<div class='row'></div>");
					divRow2.append(div1);
					//					
					$("#topicDetail-thumbnails").append(divRow2);

				},
				error: function(data, state) {
					console.log(state);
					console.log(data);
				}
			});

			$("#CommentsSubmit").click(function() {
				window.event.returnValue = false;
				
				if(userID == "") {
					alert("请先登录！");
				}
				//获取名字
				$.ajax({
					type: "get",
					url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Student/" + userID,
					//url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Student/?Student.",
					async: false,
					success: function(data, state) {
						console.log(state);
						console.log(data);

						var UserInfo = {
							userid: parseInt(userID),
							username: data.studentname,
							brief: $("#CommentsBrief").val(),
							commentstime: getFormatDate(),
							topicid: parseInt(topicID)
						};
						var dataJsonStr = JSON.stringify(UserInfo);
						console.log(dataJsonStr);
						//增加评论
						$.ajax({
							url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Comments/",
							contentType: "application/json",
							type: "POST",
							data: dataJsonStr,
							async: false,
							error: function(data, state) {
								//console.log(dataJsonStr);
								console.log(data);
								console.log(state);
								alert("评论失败！");
							},
							success: function(data, state) {
								console.log(state);
								console.log(data);
								//alert("评论成功！");
								window.location.href = "/CFIP/cfip/topic/topicDetail.html?topicID=" +topicID+ "userID=" + userID;
							}
						});

					},
					error: function(data, state) {
						console.log(state);
						console.log(data);
					}

				});

				var Commentinfor = {
					title: Title,
					authorname: Authorname,
					authorid: Authorid,
					brief: Brief,
					publishtime: Publishtime,
					commentnumber: Commentnumber + 1,
					topictype: Topictype,
					viewernumber: Viewernumber

				};
				var dataJsonStr = JSON.stringify(Commentinfor);
				console.log(dataJsonStr);
				//评论量+1
				$.ajax({
					url: "http://112.74.35.75:8080/Entity/U3d616b41047817/CFIP/Topic/" + topicID,
					contentType: "application/json",
					type: "PUT",
					data: dataJsonStr,
					async: false,
					error: function(data, state) {
						//console.log(dataJsonStr);
						console.log(data);
						console.log(state);
					},
					success: function(data, state) {
						console.log(state);
						console.log(data);
					}
				});

			});
		});
	</script>


</html>